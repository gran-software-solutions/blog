"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[2037],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=p(n),u=i,d=h["".concat(l,".").concat(u)]||h[u]||m[u]||r;return n?a.createElement(d,o(o({ref:t},c),{},{components:n})):a.createElement(d,o({ref:t},c))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},1058:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={title:"Why you should design your REST APIs with concurrency in mind",authors:"dodalovicgran",tags:["REST API"],enableComments:!0,image:"https://cdn.pixabay.com/photo/2020/05/30/08/17/rails-5238078_960_720.jpg"},o=void 0,s={permalink:"/2023/03/27/concurrency-in-rest-apis",editUrl:"https://github.com/gran-software-solutions/blog/tree/main/blog/2023-03-27-concurrency-in-rest-apis/index.mdx",source:"@site/blog/2023-03-27-concurrency-in-rest-apis/index.mdx",title:"Why you should design your REST APIs with concurrency in mind",description:"Rails",date:"2023-03-27T00:00:00.000Z",formattedDate:"March 27, 2023",tags:[{label:"REST API",permalink:"/tags/rest-api"}],readingTime:6.62,hasTruncateMarker:!0,authors:[{name:"Dusan Odalovic",title:"Software Engineer @ GRAN Software Solutions GmbH",url:"https://github.com/dodalovicgran",imageURL:"https://github.com/dodalovicgran.png",key:"dodalovicgran"}],frontMatter:{title:"Why you should design your REST APIs with concurrency in mind",authors:"dodalovicgran",tags:["REST API"],enableComments:!0,image:"https://cdn.pixabay.com/photo/2020/05/30/08/17/rails-5238078_960_720.jpg"},prevItem:{title:"To Gzip or Not to Gzip? A Guide to Using Compression in Vert.x REST APIs",permalink:"/2023/05/16/gzip-compression-guide-vertx-rest-api"},nextItem:{title:"What Is Technical Debt?",permalink:"/2023/03/22/what-is-technical-debt"}},l={authorsImageUrls:[void 0]},p=[{value:"What&#39;s the problem to solve?",id:"whats-the-problem-to-solve",level:2},{value:"Optimistic locking - the solution to &quot;lost updates&quot;",id:"optimistic-locking---the-solution-to-lost-updates",level:2},{value:"What are ETags?",id:"what-are-etags",level:2},{value:"Control concurrency with <code>If-Match</code> HTTP request header",id:"control-concurrency-with-if-match-http-request-header",level:2},{value:"Real-world example",id:"real-world-example",level:2},{value:"Design &amp; Implementation",id:"design--implementation",level:2},{value:"Saving a Wiki page",id:"saving-a-wiki-page",level:3},{value:"Getting a Wiki page",id:"getting-a-wiki-page",level:3},{value:"Sample code",id:"sample-code",level:2},{value:"What now?",id:"what-now",level:2}],c={toc:p},h="wrapper";function m(e){let{components:t,...r}=e;return(0,i.kt)(h,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("figure",null,(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Rails",src:n(1046).Z,width:"1280",height:"853"})),(0,i.kt)("figcaption",null,(0,i.kt)("center",null,"Image by ",(0,i.kt)("a",{href:"https://pixabay.com/users/furbymama-5146222/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=5238078"},"Andy M.")," from ",(0,i.kt)("a",{href:"https://pixabay.com//?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=5238078"},"Pixabay")))),(0,i.kt)("p",null,"In this article, we will show you how to design and implement a REST API that can handle concurrent requests when updating the same resource."),(0,i.kt)("p",null,"We also provided ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"#sample-code"},"a sample code"))," that demonstrates how to implement this in a real-world-like scenario of Wiki page\nmanagement API."),(0,i.kt)("h2",{id:"whats-the-problem-to-solve"},"What's the problem to solve?"),(0,i.kt)("p",null,"The issue we want to tackle is known as ",(0,i.kt)("strong",{parentName:"p"},'"lost updates"'),". When do such updates happen? When the same resources are attempted to be updated by multiple clients at the same time.\nWhat happens in such cases, if you don't have any special handling? ",(0,i.kt)("strong",{parentName:"p"},"The last update wins"),"."),(0,i.kt)("p",null,"Let's illustrate this with an example of two different users trying to update the same Wiki article:"),(0,i.kt)("br",null),(0,i.kt)("mermaid",{value:"sequenceDiagram\n    autonumber\n\n    actor User1\n    participant API\n    actor User2\n    User1->> +API: GET /wikis/1\n    User2->> API: GET /wikis/1\n    API --\x3e> User1: 200 OK\n    API --\x3e> -User2: 200 OK\n    User1 ->> +API: PUT /wikis/1\n    User2 ->> API: PUT /wikis/1\n    API --\x3e> User1: 204 No Content\n    API --\x3e> -User2: 204 No Content"}),(0,i.kt)("br",null),(0,i.kt)("p",null,"The issue with this flow is that the User2 was able to update the document, without even caring if the document might have\nchanged in the meantime. User1's update ",(0,i.kt)("strong",{parentName:"p"},"was lost"),"."),(0,i.kt)("p",null,"The solution is to make one of the two users (User2 in this case) angry \ud83d\ude42."),(0,i.kt)("p",null,"How's that? Let's read on."),(0,i.kt)("h2",{id:"optimistic-locking---the-solution-to-lost-updates"},'Optimistic locking - the solution to "lost updates"'),(0,i.kt)("p",null,'You may have noticed that some software you used in the past had a mechanism to prevent "lost updates". Let\'s take a Wiki as an example.\nAs a Wiki page is shared among your teammates, and as writing a Wiki page is a collaborative effort, and additionally takes a while to write,\nthe chances are that someone else may have updated the page as of the time you were writing your changes.'),(0,i.kt)("p",null,"Usually such tools will let you know that you need to sync your changes with the latest version of the page. This may lead to conflicts that\nyou need to resolve, before saving your work."),(0,i.kt)("p",null,"You may have expereinced the same by using Git Source Code Versioning tool. If you try to push your changes to a remote repository, and someone\nelse pushed their changes to the same branch as you, you will get an error message saying that you need to pull the remote changes first."),(0,i.kt)("p",null,"The beauty of this design is that it forces you to base your work on the work of others, ",(0,i.kt)("strong",{parentName:"p"},"whether you like it or not"),"."),(0,i.kt)("p",null,"The design implemented in both cases is called ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Optimistic_concurrency_control"},'"optimistic locking"')),".\nSimply put, it's an assumption that the transactions will not interfere often, and that there is no need to lock the resources they may change. Instead,\ntransactions are allowed to change the data, but before they are committed, there is a check to see if the data has been changed in the meantime. Non\nlocking approach brings a performance benefit."),(0,i.kt)("p",null,'Later in this article, we will show an example of the Wiki page management API, and we will use optimistic locking to prevent "lost updates".'),(0,i.kt)("p",null,"Technical means we will use to implement optimistic locking are ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"If-Match")," HTTP headers."),(0,i.kt)("p",null,"Let's learn first about ETags first."),(0,i.kt)("h2",{id:"what-are-etags"},"What are ETags?"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ETag")," (stands for ",(0,i.kt)("strong",{parentName:"p"},"E"),"ntity Tag) is an ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag#avoiding_mid-air_collisions"},"HTTP response header")),". The value of\nthis header is an opaque identifier assigned by servers to specific versions of resources. If the content of the resource changes, the ETag changes as well.\nETag is used for caching purposes, as well as for concurrency control. An example of an ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag")," header:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-http"},'GET /api/v1/documents/123 HTTP/1.1\nHost: example.com\nAccept: application/json\n\nHTTP/1.1 200 OK\nContent-Type: application/json\nETag: "bfc13a64729c4290ef5b2c2730249c88ca92d82d"\n\n{\n  "id": 123,\n  "title": "My document",\n  "content": "This is my document"\n}\n')),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"There are 2 types of ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s: ",(0,i.kt)("strong",{parentName:"p"},"weak")," and ",(0,i.kt)("strong",{parentName:"p"},"strong"),".\nStrong ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s imply byte-by-byte equality. Weak ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s imply semantic equality."),(0,i.kt)("p",{parentName:"admonition"},"Technically, weak ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s are prefixed with ",(0,i.kt)("inlineCode",{parentName:"p"},"W/"),". Strong ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s are not prefixed."),(0,i.kt)("p",{parentName:"admonition"},"An example of a weak ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag")," would be ",(0,i.kt)("inlineCode",{parentName:"p"},'W/"bakck3"'),", whereas an example of a strong ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag")," would be ",(0,i.kt)("inlineCode",{parentName:"p"},'"bfc13a64729c4290ef5b2c2730249c88ca92d82d"'),"."),(0,i.kt)("p",{parentName:"admonition"},"Strong ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s are usually preferred, as they are more reliable. However, they are more expensive to compute\nAs strong ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s are preferred by ",(0,i.kt)("inlineCode",{parentName:"p"},"If-Match")," header, we will use them in our example."),(0,i.kt)("p",{parentName:"admonition"},"Read more about ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s in ",(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag"},"MDN Web Docs"),".")),(0,i.kt)("h2",{id:"control-concurrency-with-if-match-http-request-header"},"Control concurrency with ",(0,i.kt)("inlineCode",{parentName:"h2"},"If-Match")," HTTP request header"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"If-Match")," ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Match"},"request header"))," makes the request conditional.\n",(0,i.kt)("inlineCode",{parentName:"p"},"If-Match")," contains list of ",(0,i.kt)("inlineCode",{parentName:"p"},"ETag"),"s. The flow works like this:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"A user requests a resource from the server, and the server responds with the resource and its ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag"),"."),(0,i.kt)("li",{parentName:"ol"},"User makes local modification to the resource"),(0,i.kt)("li",{parentName:"ol"},"User sends the modified resource to the server, along with the ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag")," of the resource it received from the server. This ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag")," is sent in\n",(0,i.kt)("inlineCode",{parentName:"li"},"If-Match")," header."),(0,i.kt)("li",{parentName:"ol"},"Server checks if the ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag")," in ",(0,i.kt)("inlineCode",{parentName:"li"},"If-Match")," header matches the ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag")," of the resource on the server. If they match, the server proceeds with\nhandling the request."),(0,i.kt)("li",{parentName:"ol"},"If the ",(0,i.kt)("inlineCode",{parentName:"li"},"ETag"),"s don't match, the server responds with ",(0,i.kt)("inlineCode",{parentName:"li"},"412 Precondition Failed")," response.")),(0,i.kt)("p",null,"Let's illustrate this with an example based on our Wiki page management API:"),(0,i.kt)("br",null),(0,i.kt)("mermaid",{value:"sequenceDiagram\n    autonumber\n\n    actor User1\n    participant API\n    actor User2\n    User1->> +API: GET /wikis/1\n    User2->> API: GET /wikis/1\n    API --\x3e> User1: 200 OK<br/>Etag: 1\n    API --\x3e> -User2: 200 OK<br/>Etag: 1\n    User1 ->> +API: PUT /wikis/1<br/>ETag: 1\n    User2 ->> API: PUT /wikis/1<br/>ETag: 1\n    API --\x3e> User1: 204 No Content<br/>Etag: 2\n    API --\x3e> -User2: 412 Precondition Failed<br/>"}),(0,i.kt)("h2",{id:"real-world-example"},"Real-world example"),(0,i.kt)("p",null,"As mentioned earlier, we designed the Wiki page management API. It provides the following user experience:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Action sequence",src:n(4266).Z,width:"3046",height:"2236"})),(0,i.kt)("h2",{id:"design--implementation"},"Design & Implementation"),(0,i.kt)("p",null,"To be able to achieve such a user experience, we came up with the following API design:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"We will need 2 API operations, one to ",(0,i.kt)("strong",{parentName:"li"},"save")," and one to ",(0,i.kt)("strong",{parentName:"li"},"get")," a Wiki page"),(0,i.kt)("li",{parentName:"ul"},"We will use ",(0,i.kt)("strong",{parentName:"li"},"strong ETags")," and ",(0,i.kt)("strong",{parentName:"li"},"If-Match")," HTTP headers")),(0,i.kt)("h3",{id:"saving-a-wiki-page"},"Saving a Wiki page"),(0,i.kt)("p",null,"We designed saving a Wiki page so that it will use an idempotent ",(0,i.kt)("inlineCode",{parentName:"p"},"PUT")," HTTP method. This method will be used to create a new document,\nas well as to update an existing one. Clients are allowed to set the ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," of a Wiki page."),(0,i.kt)("p",null,"The following is a flowchart of how the API operation was implemented:"),(0,i.kt)("mermaid",{value:"flowchart TD\n    A([Start]) --\x3e B{Request body present?}\n    B -- Yes --\x3e C[Get wikiID path param]\n    C --\x3e D[Get the WIki page from DB by wikiID]\n    D --\x3e E{Wiki page exists?}\n    E -- No --\x3e F[Save new Wiki page]\n    F --\x3e G([HTTP 204])\n    E -- Yes --\x3e H[Get If-Match header value from request]\n    H --\x3e I{Value missing?}\n    I -- Yes --\x3e J([HTTP 428 - Precondition required])\n    I -- No --\x3e K{Request ETag == Wiki page Etag?}\n    K -- Yes --\x3e L[Update Wiki page]\n    L --\x3e G\n    K -- No --\x3e  N([HTTP 412 -Precondition failed])\n    B -- No ----\x3e O([HTTP 400 - Bad request])"}),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"The algorithm above strictly follows the ",(0,i.kt)("a",{parentName:"p",href:"https://www.rfc-editor.org/rfc/rfc7232#section-5"},"RFC 7232")," specification.")),(0,i.kt)("h3",{id:"getting-a-wiki-page"},"Getting a Wiki page"),(0,i.kt)("p",null,"Getting a Wiki page is far simpler. Using standard ",(0,i.kt)("inlineCode",{parentName:"p"},"GET")," HTTP method, we will return the Wiki page with the provided ",(0,i.kt)("inlineCode",{parentName:"p"},"wikiId"),".\nIf there's no such page with the provided ",(0,i.kt)("inlineCode",{parentName:"p"},"wikiId"),", we will return ",(0,i.kt)("inlineCode",{parentName:"p"},"404 Not Found"),"."),(0,i.kt)("p",null,"The following is a flowchart of how the API operation was implemented:"),(0,i.kt)("mermaid",{value:"flowchart TD\n    A([Start]) --\x3e B[Resolve a Wiki page by provided wikiID]\n    B --\x3e C{Wiki page exists?}\n    C -- No --\x3e D([HTTP 404])\n    C -- Yes --\x3e E([HTTP 200])"}),(0,i.kt)("h2",{id:"sample-code"},"Sample code"),(0,i.kt)("p",null,"On our GitHub, we've published ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/gran-software-solutions/code-samples/tree/main/concurrency-in-rest-apis"},"a sample project"))," that implements the described API.\nThe sample code is written in ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://kotlinlang.org/"},"Kotlin"))," using ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://vertx.io/"},"Vert.x"))," toolkit. It requires having ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://adoptopenjdk.net/"},"JDK 11"))," or newer installed"),(0,i.kt)("p",null,"The code contains a README file, with instructions on how to ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/gran-software-solutions/code-samples/tree/main/concurrency-in-rest-apis#running-application"},"run the app"))," and how to ",(0,i.kt)("u",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/gran-software-solutions/code-samples/tree/main/concurrency-in-rest-apis#how-to-interact-with-the-running-application"},"interact with it"))),(0,i.kt)("h2",{id:"what-now"},"What now?"),(0,i.kt)("p",null,"Are there use-cases where your API consumers can manage the same resource? To avoid data loss, use optimistic locking."))}m.isMDXComponent=!0},4266:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/action-sequence-6613a97b77df80415b326523ac0095eb.png"},1046:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rails-eb1f8d6c01ad6dcbf828de21db10d611.jpg"}}]);