"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[1248],{5680:(e,n,t)=>{t.d(n,{xA:()=>p,yg:()=>y});var r=t(6540);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),u=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=u(e.components);return r.createElement(s.Provider,{value:n},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(t),d=a,y=c["".concat(s,".").concat(d)]||c[d]||g[d]||i;return t?r.createElement(y,l(l({ref:n},p),{},{components:t})):r.createElement(y,l({ref:n},p))}));function y(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,l=new Array(i);l[0]=d;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[c]="string"==typeof e?e:a,l[1]=o;for(var u=2;u<i;u++)l[u]=t[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},9041:(e,n,t)=>{t.d(n,{A:()=>a});var r=t(6540);const a=function(e){const n=e.width?{width:`${e.width}px`}:{};return void 0!==e.title?r.createElement("center",null,r.createElement("figure",null,r.createElement("img",{src:e.src,alt:e.alt,style:n}),r.createElement("figcaption",{style:{textAlign:"center"}},e.title))):r.createElement("img",{src:e.src,alt:e.alt,style:n})}},6839:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var r=t(8168),a=(t(6540),t(5680)),i=t(9041);const l={title:"Beyond SSH Tunnels: Secure K8s Access with WireGuard & Ansible",authors:"gglazewskigran",tags:["ansible","k8s","wireguard","security","devops"],enableComments:!0},o=void 0,s={permalink:"/2025/07/04/k8s-wireguard-access",source:"@site/blog/2025-07-04-k8s-wireguard-access/index.mdx",title:"Beyond SSH Tunnels: Secure K8s Access with WireGuard & Ansible",description:'<MyImg src={require("./orcs.jpeg").default} alt="A digital painting in a retro 80s style depicting a horde of orcs in ushankas and orange armor laying siege to a formidable white castle under a dark, stormy sky."',date:"2025-07-04T00:00:00.000Z",formattedDate:"July 4, 2025",tags:[{label:"ansible",permalink:"/tags/ansible"},{label:"k8s",permalink:"/tags/k-8-s"},{label:"wireguard",permalink:"/tags/wireguard"},{label:"security",permalink:"/tags/security"},{label:"devops",permalink:"/tags/devops"}],readingTime:6.33,hasTruncateMarker:!0,authors:[{name:"Greg Glazewski",title:"Software Engineer @ GRAN Software Solutions GmbH",url:"https://www.linkedin.com/in/greg-glazewski-88390827",imageURL:"https://github.com/gglazewskigran.png",key:"gglazewskigran"}],frontMatter:{title:"Beyond SSH Tunnels: Secure K8s Access with WireGuard & Ansible",authors:"gglazewskigran",tags:["ansible","k8s","wireguard","security","devops"],enableComments:!0},prevItem:{title:"Automating Production Postgres on Kubernetes: A PGO and Ansible IaC Pattern",permalink:"/2025/07/14/a-pgo-and-ansible-iac-pattern"},nextItem:{title:"Sheetty Teams: Collaborate and Track Time Together",permalink:"/2024/04/29/sheetty-teams-intro"}},u={authorsImageUrls:[void 0]},p=[{value:"The &quot;Why&quot;: My Motivations",id:"the-why-my-motivations",level:2},{value:"The &quot;How&quot;: The Architecture and Setup",id:"the-how-the-architecture-and-setup",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"The Core Components: Templates and Variables",id:"the-core-components-templates-and-variables",level:3},{value:"Step 1 &amp; 2: The Server Setup &amp; Ansible Automation",id:"step-1--2-the-server-setup--ansible-automation",level:3},{value:"Step 3: Configuring a New Client (The Full Workflow)",id:"step-3-configuring-a-new-client-the-full-workflow",level:3},{value:"The &quot;Aha!&quot; Moment: Using the Connection",id:"the-aha-moment-using-the-connection",level:3},{value:"Conclusion",id:"conclusion",level:3}],c={toc:p},g="wrapper";function d(e){let{components:n,...l}=e;return(0,a.yg)(g,(0,r.A)({},c,l,{components:n,mdxType:"MDXLayout"}),(0,a.yg)(i.A,{src:t(2341).A,alt:"A digital painting in a retro 80s style depicting a horde of orcs in ushankas and orange armor laying siege to a formidable white castle under a dark, stormy sky.",title:"Even the most secure fortress can face an unexpected horde",mdxType:"MyImg"}),(0,a.yg)("p",null,"Directly accessing Kubernetes services from outside the cluster can be a security and convenience nightmare. Tedious ",(0,a.yg)("inlineCode",{parentName:"p"},"port-forward")," commands and exposed proxies are risky. This post details how I built a better solution: a secure, automated VPN tunnel into my cluster using WireGuard and Ansible, giving me direct, private network access to my K3s cluster."),(0,a.yg)("h2",{id:"the-why-my-motivations"},'The "Why": My Motivations'),(0,a.yg)("p",null,"My journey began after hardening our servers per CIS Benchmarks, a standard security practice. This had an immediate side effect: my usual method of creating an ",(0,a.yg)("strong",{parentName:"p"},"SSH tunnel")," to use ",(0,a.yg)("inlineCode",{parentName:"p"},"kubectl")," was disabled."),(0,a.yg)("p",null,"This was a blessing in disguise. Relying on any kind of forwarded port is a security risk, as it can potentially allow traceless horizontal attacks across your cluster if a developer's machine is compromised. I needed a better, more secure, and more robust way forward."),(0,a.yg)("p",null,"WireGuard was the obvious choice\u2014it's the modern, fast, and secure de-facto standard for Kubernetes networking, using state-of-the-art cryptography. To make the entire setup repeatable and error-proof, I turned to Ansible for complete automation."),(0,a.yg)("h2",{id:"the-how-the-architecture-and-setup"},'The "How": The Architecture and Setup'),(0,a.yg)("p",null,"The architecture is simple: a WireGuard peer runs as a VPN server directly on our Kubernetes node (in this case, a VPS running K3s). Our client machines (laptops, etc.) connect to this peer, effectively joining the cluster's private network."),(0,a.yg)("h3",{id:"prerequisites"},"Prerequisites"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"A running Kubernetes cluster (this guide uses K3s on a VPS)."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"kubectl")," access to that cluster."),(0,a.yg)("li",{parentName:"ul"},"Ansible installed on your control machine."),(0,a.yg)("li",{parentName:"ul"},"A basic grasp of WireGuard concepts (Peers, Public/Private Keys).")),(0,a.yg)("h3",{id:"the-core-components-templates-and-variables"},"The Core Components: Templates and Variables"),(0,a.yg)("p",null,"Before diving into the playbook, let's look at the two key templates it uses."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"1. The Server Configuration Template (",(0,a.yg)("inlineCode",{parentName:"strong"},"wg0.conf.j2"),")")),(0,a.yg)("p",null,"This is a Jinja2 template that Ansible uses to generate the server's final ",(0,a.yg)("inlineCode",{parentName:"p"},"/etc/wireguard/wg0.conf")," file. Its power comes from the ",(0,a.yg)("inlineCode",{parentName:"p"},"for")," loop, which dynamically adds a ",(0,a.yg)("inlineCode",{parentName:"p"},"[Peer]")," block for every client defined in an Ansible variable."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-jinja"},"[Interface]\nAddress = {{ wireguard_server_ip }}/24\nListenPort = {{ wireguard_server_port }}\nPrivateKey = PLACEHOLDER\n\n{% for client in wireguard_clients %}\n[Peer]\n# {{ client.name }}\nPublicKey = {{ client.public_key }}\nAllowedIPs = {{ client.ip }}/32\n{% endfor %}\n")),(0,a.yg)("p",null,"You would define the ",(0,a.yg)("inlineCode",{parentName:"p"},"wireguard_clients")," variable in your Ansible inventory (e.g., in ",(0,a.yg)("inlineCode",{parentName:"p"},"group_vars/all.yml"),") like this:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-yaml"},'wireguard_clients:\n  - name: my_laptop\n    public_key: "PASTE_LAPTOP_PUBLIC_KEY_HERE"\n    ip: "10.0.0.2"\n  - name: my_phone\n    public_key: "PASTE_PHONE_PUBLIC_KEY_HERE"\n    ip: "10.0.0.3"\n')),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"2. The Client Template (",(0,a.yg)("inlineCode",{parentName:"strong"},"wg-client-template.conf"),")")),(0,a.yg)("p",null,"This file lives on your local machine where you run Ansible. It's a generic client config with placeholders. Ansible will automatically fill in the server's ",(0,a.yg)("inlineCode",{parentName:"p"},"PublicKey")," and ",(0,a.yg)("inlineCode",{parentName:"p"},"Endpoint")," details."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-ini"},"[Interface]\nPrivateKey = {{CLIENT_PRIVATE_KEY}}\nAddress = {{CLIENT_IP}}\n\n[Peer]\nPublicKey = {{PUBLIC_KEY}}\nEndpoint = {{ENDPOINT}}\nAllowedIPs = 10.0.0.0/24\nPersistentKeepalive = 25\n")),(0,a.yg)("h3",{id:"step-1--2-the-server-setup--ansible-automation"},"Step 1 & 2: The Server Setup & Ansible Automation"),(0,a.yg)("p",null,"Our Ansible role, ",(0,a.yg)("inlineCode",{parentName:"p"},"wireguard"),", automates the entire server configuration."),(0,a.yg)("p",null,"Here is the main task file:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-yaml"},"# ansible/wireguard/tasks/main.yaml\n\n- name: Ensure WireGuard tools are installed\n  ansible.builtin.package:\n    name: wireguard-tools\n    state: present\n\n- name: Ensure UFW is installed\n  ansible.builtin.package:\n    name: ufw\n    state: present\n\n- name: Create WireGuard config directory\n  ansible.builtin.file:\n    path: /etc/wireguard\n    state: directory\n    mode: '0700'\n\n- name: Check for existing private key\n  ansible.builtin.stat:\n    path: /etc/wireguard/private_key\n  register: private_key_stat\n\n- name: Generate WireGuard keys on server\n  ansible.builtin.shell:\n    cmd: umask 077 && wg genkey > /etc/wireguard/private_key && wg pubkey < /etc/wireguard/private_key > /etc/wireguard/public_key\n    creates: /etc/wireguard/private_key\n  when: not private_key_stat.stat.exists\n\n- name: Slurp WireGuard public key from remote server\n  ansible.builtin.slurp:\n    src: /etc/wireguard/public_key\n  register: wireguard_public_key_b64\n\n- name: Insert server public key into the client template\n  ansible.builtin.lineinfile:\n    path: \"/project/wg-client-template.conf\"\n    regexp: '^PublicKey = .*$'\n    line: \"PublicKey = {{ wireguard_public_key_b64['content'] | b64decode }}\"\n    mode: '0644'\n  delegate_to: localhost\n  run_once: true\n  become: no\n\n- name: Insert server endpoint into the client template\n  ansible.builtin.lineinfile:\n    path: \"/project/wg-client-template.conf\"\n    regexp: '^Endpoint = .*$'\n    line: \"Endpoint = {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:{{ wireguard_server_port }}\"\n    mode: '0644'\n  delegate_to: localhost\n  run_once: true\n  become: no\n\n- name: Configure WireGuard interface from template\n  ansible.builtin.template:\n    src: wg0.conf.j2\n    dest: /etc/wireguard/wg0.conf\n    owner: root\n    group: root\n    mode: '0600'\n\n- name: Read private key from server file\n  ansible.builtin.command: cat /etc/wireguard/private_key\n  register: private_key_content\n  changed_when: false\n  check_mode: no\n  no_log: true\n\n- name: Insert private key into WireGuard config\n  ansible.builtin.lineinfile:\n    path: /etc/wireguard/wg0.conf\n    line: \"PrivateKey = {{ private_key_content.stdout }}\"\n    regexp: '^PrivateKey = PLACEHOLDER$'\n    state: present\n  no_log: true\n  notify: restart wireguard\n\n- name: Allow WireGuard port through UFW\n  community.general.ufw:\n    rule: allow\n    port: \"{{ wireguard_server_port }}\"\n    proto: udp\n  notify: reload ufw\n\n- name: Enable IP forwarding in UFW\n  ansible.builtin.lineinfile:\n    path: /etc/default/ufw\n    regexp: '^DEFAULT_FORWARD_POLICY='\n    line: 'DEFAULT_FORWARD_POLICY=\"ACCEPT\"'\n  notify: reload ufw\n\n- name: Add UFW Postrouting rule for NAT\n  ansible.builtin.blockinfile:\n    path: /etc/ufw/before.rules\n    block: |\n      # START WIREGUARD RULES\n      *nat\n      :POSTROUTING ACCEPT [0:0]\n      -A POSTROUTING -s {{ wireguard_server_ip }}/24 -o {{ ansible_default_ipv4.interface }} -j MASQUERADE\n      COMMIT\n      # END WIREGUARD RULES\n    marker: \"# {mark} ANSIBLE MANAGED BLOCK for WireGuard NAT\"\n  notify: reload ufw\n\n- name: Allow K3s API port through UFW from WireGuard network\n  community.general.ufw:\n    rule: allow\n    port: '6443'\n    proto: tcp\n    from_ip: \"{{ wireguard_server_ip }}/24\"\n  notify: reload ufw\n\n- name: Ensure WireGuard service is enabled and started\n  ansible.builtin.service:\n    name: wg-quick@wg0\n    enabled: true\n    state: started\n")),(0,a.yg)("h3",{id:"step-3-configuring-a-new-client-the-full-workflow"},"Step 3: Configuring a New Client (The Full Workflow)"),(0,a.yg)("p",null,"Here is the complete process to add a new client (e.g., your laptop) to the VPN."),(0,a.yg)("ol",null,(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},(0,a.yg)("strong",{parentName:"p"},"Generate Client Keys:")," On your local machine, generate a new key pair."),(0,a.yg)("pre",{parentName:"li"},(0,a.yg)("code",{parentName:"pre",className:"language-bash"},"wg genkey | tee my_laptop_private.key | wg pubkey > my_laptop_public.key\n")),(0,a.yg)("p",{parentName:"li"},"Keep the private key safe! You'll need it in a moment.")),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},(0,a.yg)("strong",{parentName:"p"},"Update Ansible Variables:")," Copy the contents of ",(0,a.yg)("inlineCode",{parentName:"p"},"my_laptop_public.key"),". Now, open your Ansible ",(0,a.yg)("inlineCode",{parentName:"p"},"wireguard_clients")," variable list and add a new entry for your device."),(0,a.yg)("pre",{parentName:"li"},(0,a.yg)("code",{parentName:"pre",className:"language-yaml"},'wireguard_clients:\n  - name: my_laptop\n    public_key: "COPIED_PUBLIC_KEY_GOES_HERE"\n    ip: "10.0.0.2"\n  # ... other clients\n'))),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},(0,a.yg)("strong",{parentName:"p"},"Run the Playbook:")," Execute your Ansible playbook. This will update the server's ",(0,a.yg)("inlineCode",{parentName:"p"},"/etc/wireguard/wg0.conf")," file, adding your new laptop as a peer. It will also update your local ",(0,a.yg)("inlineCode",{parentName:"p"},"wg-client-template.conf")," with the correct server info.")),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},(0,a.yg)("strong",{parentName:"p"},"Create Your Final Client Config:")),(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},"Open the now-updated ",(0,a.yg)("inlineCode",{parentName:"li"},"wg-client-template.conf"),"."),(0,a.yg)("li",{parentName:"ul"},"Copy the private key from ",(0,a.yg)("inlineCode",{parentName:"li"},"my_laptop_private.key")," and paste it over the ",(0,a.yg)("inlineCode",{parentName:"li"},"{{CLIENT_PRIVATE_KEY}}")," placeholder."),(0,a.yg)("li",{parentName:"ul"},"Replace ",(0,a.yg)("inlineCode",{parentName:"li"},"{{CLIENT_IP}}")," with the same IP you used in the variable list (",(0,a.yg)("inlineCode",{parentName:"li"},"10.0.0.2"),")."),(0,a.yg)("li",{parentName:"ul"},"Save this final file as ",(0,a.yg)("inlineCode",{parentName:"li"},"wg0.conf")," on your laptop (e.g., in ",(0,a.yg)("inlineCode",{parentName:"li"},"/etc/wireguard/"),")."))),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},(0,a.yg)("strong",{parentName:"p"},"Connect:")," Activate the tunnel using the WireGuard client on your OS (e.g., ",(0,a.yg)("inlineCode",{parentName:"p"},"wg-quick up wg0"),"). You're in!"))),(0,a.yg)("h3",{id:"the-aha-moment-using-the-connection"},'The "Aha!" Moment: Using the Connection'),(0,a.yg)("p",null,"Once the tunnel is active, you can access your cluster resources as if you were on the same local network. To confirm that ",(0,a.yg)("inlineCode",{parentName:"p"},"kubectl")," can now see the cluster through the tunnel, you can run a simple command. Pointing ",(0,a.yg)("inlineCode",{parentName:"p"},"kubectl")," directly to your server's WireGuard IP (e.g., ",(0,a.yg)("inlineCode",{parentName:"p"},"10.0.0.1"),", as defined in your ",(0,a.yg)("inlineCode",{parentName:"p"},"wg0.conf.j2"),") should now work perfectly."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-bash"},"# Test kubectl access through the tunnel, replacing with your server's WG IP\nkubectl --server [https://10.0.0.1:6443](https://10.0.0.1:6443) get all --all-namespaces\n")),(0,a.yg)("p",null,"You can even access services by their internal ClusterIP. For instance, ",(0,a.yg)("inlineCode",{parentName:"p"},"curl http://10.43.0.15")," will just work."),(0,a.yg)("p",null,"More importantly, you can now permanently configure your ",(0,a.yg)("inlineCode",{parentName:"p"},"~/.kube/config")," file to point directly to the internal Kubernetes API server address (",(0,a.yg)("inlineCode",{parentName:"p"},"https://10.0.0.1:6443"),"), removing any need for the API server to be exposed to the public internet."),(0,a.yg)("h3",{id:"conclusion"},"Conclusion"),(0,a.yg)("p",null,"By combining WireGuard and Ansible, we've created a robust, secure, and easy-to-manage way to access our Kubernetes resources. It's faster and more flexible than clunky SSH tunnels and more modern than older VPN solutions. The best part is that the entire process is automated, making it repeatable, reliable, and trivial to onboard new developers or devices."))}d.isMDXComponent=!0},2341:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/orcs-0755c3609018904693442caa3dd0c7cc.jpeg"}}]);